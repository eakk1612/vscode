import google.generativeai as genai
import csv
import time
import sys

# ==========================================
# 1. à¹ƒà¸ªà¹ˆ API Key
# ==========================================
GOOGLE_API_KEY = "AIzaSyAzrxUYf12ExdL-va_YU7NODKaFJ4MsmGI" # <--- à¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¹ƒà¸ªà¹ˆ API Key à¸™à¸°à¸„à¸£à¸±à¸š
genai.configure(api_key=GOOGLE_API_KEY)

# ==========================================
# 2. à¹€à¸•à¸£à¸µà¸¢à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
# ==========================================
print("ðŸ“‚ à¸à¸³à¸¥à¸±à¸‡à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œ training_data.csv ...")
training_data = []

try:
    with open('training_data.csv', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            if 'input' in row and 'output' in row:
                training_data.append({
                    "text_input": row['input'],
                    "output": row['output'],
                })
    print(f"âœ… à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸£à¹‰à¸­à¸¡à¹€à¸—à¸£à¸™: {len(training_data)} à¸„à¸¹à¹ˆ")
except Exception as e:
    print(f"âŒ Error: {e}")
    sys.exit()

# ==========================================
# 3. à¸¥à¸­à¸‡à¹„à¸¥à¹ˆà¸«à¸²à¹‚à¸¡à¹€à¸”à¸¥à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹„à¸”à¹‰ (Auto-Select)
# ==========================================
# à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¹‚à¸¡à¹€à¸”à¸¥à¸—à¸µà¹ˆà¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¸ˆà¸¹à¸™ (à¸ˆà¸°à¸¥à¸­à¸‡à¹„à¸¥à¹ˆà¸ˆà¸²à¸à¸šà¸™à¸¥à¸‡à¸¥à¹ˆà¸²à¸‡)
candidate_models = [
    "models/gemini-1.0-pro-001",      # à¸•à¸±à¸§à¸¡à¸²à¸•à¸£à¸à¸²à¸™ (à¹€à¸ªà¸–à¸µà¸¢à¸£à¸ªà¸¸à¸”à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ˆà¸¹à¸™)
    "models/gemini-1.5-flash-001-tuning",
    "models/gemini-1.5-flash-001",
    "models/gemini-1.0-pro-tuning"
]

selected_model = None

print("\nðŸ” à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸«à¸² Base Model à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸ˆà¸¹à¸™à¹„à¸”à¹‰...")
for model in candidate_models:
    try:
        # à¸¥à¸­à¸‡à¸ªà¹ˆà¸‡à¸„à¸³à¸‚à¸­à¹à¸šà¸šà¸«à¸¥à¸­à¸à¹† à¹€à¸žà¸·à¹ˆà¸­à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¸Šà¸·à¹ˆà¸­à¹‚à¸¡à¹€à¸”à¸¥à¸œà¹ˆà¸²à¸™à¹„à¸«à¸¡
        # (à¸–à¹‰à¸²à¸Šà¸·à¹ˆà¸­à¸œà¸´à¸” à¸¡à¸±à¸™à¸ˆà¸° Error à¸—à¸±à¸™à¸—à¸µ à¹€à¸£à¸²à¸à¹‡à¸ˆà¸±à¸š Error à¹à¸¥à¹‰à¸§à¸‚à¹‰à¸²à¸¡à¹„à¸›à¸•à¸±à¸§à¸•à¹ˆà¸­à¹„à¸›)
        print(f"   à¸à¸³à¸¥à¸±à¸‡à¸—à¸”à¸ªà¸­à¸š: {model} ... ", end="")
        
        # à¸•à¸±à¹‰à¸‡à¸Šà¸·à¹ˆà¸­à¹‚à¸¡à¹€à¸”à¸¥
        my_model_name = "cpe-chatbot-final-v1" 
        
        operation = genai.create_tuned_model(
            display_name=my_model_name,
            source_model=model,
            epoch_count=20,
            batch_size=4,
            learning_rate=0.001,
            training_data=training_data
        )
        
        # à¸–à¹‰à¸²à¸šà¸£à¸£à¸—à¸±à¸”à¸šà¸™à¸œà¹ˆà¸²à¸™ à¹à¸›à¸¥à¸§à¹ˆà¸²à¹ƒà¸Šà¹‰à¹„à¸”à¹‰!
        print("âœ… à¸œà¹ˆà¸²à¸™!")
        selected_model = model
        break # à¸«à¸¢à¸¸à¸”à¸„à¹‰à¸™à¸«à¸²
    except Exception as e:
        if "not found" in str(e) or "404" in str(e) or "400" in str(e):
            print("âŒ à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š")
        else:
            print(f"\nâš ï¸ Error à¸­à¸·à¹ˆà¸™à¹†: {e}")
            # à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ Error à¸­à¸·à¹ˆà¸™à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸Šà¸·à¹ˆà¸­à¸œà¸´à¸” à¸­à¸²à¸ˆà¸ˆà¸°à¸«à¸¢à¸¸à¸”à¹€à¸¥à¸¢
            break

if not selected_model:
    print("\nâŒ à¹„à¸¡à¹ˆà¸žà¸šà¹‚à¸¡à¹€à¸”à¸¥à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸ˆà¸¹à¸™à¹„à¸”à¹‰à¹€à¸¥à¸¢à¹ƒà¸™à¸šà¸±à¸à¸Šà¸µà¸™à¸µà¹‰")
    print("à¸„à¸³à¹à¸™à¸°à¸™à¸³: à¸šà¸±à¸à¸Šà¸µà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸­à¸²à¸ˆà¸ˆà¸°à¹€à¸›à¹‡à¸™à¸šà¸±à¸à¸Šà¸µà¹ƒà¸«à¸¡à¹ˆà¸¡à¸²à¸ à¸«à¸£à¸·à¸­à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸à¸²à¸£à¸ˆà¸¹à¸™à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸›à¸´à¸”")
    sys.exit()

# ==========================================
# 4. à¸£à¸­à¸œà¸¥à¸à¸²à¸£à¹€à¸—à¸£à¸™
# ==========================================
print(f"\nðŸš€ à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸à¸²à¸£à¹€à¸—à¸£à¸™à¸”à¹‰à¸§à¸¢à¹‚à¸¡à¹€à¸”à¸¥: {selected_model}")
print(f"ID à¸‡à¸²à¸™à¹€à¸—à¸£à¸™: {operation.name}")
print("â³ à¸à¸³à¸¥à¸±à¸‡à¹€à¸—à¸£à¸™... (à¸«à¹‰à¸²à¸¡à¸›à¸´à¸”à¹‚à¸›à¸£à¹à¸à¸£à¸¡ à¸£à¸­à¸›à¸£à¸°à¸¡à¸²à¸“ 5 à¸™à¸²à¸—à¸µ)")

try:
    # à¸§à¸™à¸¥à¸¹à¸›à¹€à¸Šà¹‡à¸„à¸ªà¸–à¸²à¸™à¸°
    for status in operation.wait_bar():
        time.sleep(10)

    result = operation.result()
    print("\n" + "="*50)
    print("ðŸŽ‰ðŸŽ‰ à¹€à¸—à¸£à¸™à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ 100% ðŸŽ‰ðŸŽ‰")
    print("="*50)
    print(f"à¸Šà¸·à¹ˆà¸­à¹‚à¸¡à¹€à¸”à¸¥à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸·à¸­ (à¹€à¸­à¸²à¹„à¸›à¹ƒà¸ªà¹ˆà¹ƒà¸™ app.py): \n\n{result.name}\n") 
    print("="*50)

except Exception as e:
    print(f"\nâŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸£à¸­: {e}")